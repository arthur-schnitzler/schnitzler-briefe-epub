name: Alle back-Elemente neu rechnen (monatlich)

on:
  schedule:
    # LÃ¤uft am 1. jeden Monats um 2:00 UTC
    - cron: '0 2 1 * *'
  workflow_dispatch: # ErmÃ¶glicht manuellen Start

jobs:
  update-back-elements:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # VollstÃ¤ndige Git-Historie fÃ¼r Ã„nderungserkennung
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests lxml
    
    - name: Cache PMB files
      uses: actions/cache@v3
      with:
        path: python-temp/
        key: pmb-files-${{ github.run_id }}-${{ github.run_attempt }}
        restore-keys: |
          pmb-files-
    
    - name: Check for changes in editions folder in the last month
      id: check-changes
      run: |
        # Datum vor einem Monat berechnen
        LAST_MONTH=$(date -d "1 month ago" +%Y-%m-%d)
        echo "Checking for changes since: $LAST_MONTH"
        
        # PrÃ¼fen ob es Ã„nderungen in ./editions/ seit dem letzten Monat gab
        CHANGES=$(git log --since="$LAST_MONTH" --oneline --name-only -- editions/ | wc -l)
        echo "Found $CHANGES changes in editions/ folder"
        
        if [ $CHANGES -eq 0 ]; then
          echo "No changes found in editions/ folder since $LAST_MONTH"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes found in editions/ folder since $LAST_MONTH"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Liste der geÃ¤nderten Dateien fÃ¼r das Commit-Message
          git log --since="$LAST_MONTH" --name-only --pretty=format: -- editions/ | sort | uniq | head -10 > changed_files.txt
          echo "Changed files (first 10):"
          cat changed_files.txt
        fi
    
    - name: Configure Git for intermediate commits
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action (Batch Processing)"

    - name: Run back element batch processing
      if: steps.check-changes.outputs.has_changes == 'true'
      timeout-minutes: 120  # Gesamt-Timeout fÃ¼r diesen Step (2 Stunden)
      continue-on-error: true  # Workflow soll auch bei Timeouts oder Fehlern weiterlaufen
      run: |
        echo "Starting optimized batch processing of back elements..."
        echo "ðŸ“¥ Step 1: Downloading/checking PMB lists (listperson.xml, listbibl.xml, etc.)..."
        echo "âš™ï¸  Step 2: Using optimized PMB loading system (minimal memory usage, fast startup)..."
        echo "ðŸ”„ Step 3: Running parallel processing on editions/ folder (3 processes)..."
        echo "ðŸ’¾ Intermediate commits will be created every 100 successful files"
        echo ""
        python -u python/batch_process_back-element.py --parallel 3 --commit-interval 100 || echo "Batch processing finished with some errors/timeouts, but continuing..."
        echo "Batch processing step completed"
    
    - name: Check for actual file changes after processing
      if: always() && steps.check-changes.outputs.has_changes == 'true'  # LÃ¤uft auch bei Fehlern im vorherigen Step
      id: check-git-changes
      run: |
        # Da Zwischencommits gemacht wurden, prÃ¼fen wir ob noch uncommitted changes da sind
        git add -A
        if git diff --staged --quiet; then
          echo "No additional files need to be committed (intermediate commits handled everything)"
          echo "files_changed=false" >> $GITHUB_OUTPUT
        else
          echo "Additional files need to be committed in final commit"
          echo "files_changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Configure Git
      if: always() && steps.check-git-changes.outputs.files_changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Commit and push changes
      if: always() && steps.check-git-changes.outputs.files_changed == 'true'
      run: |
        # Erstelle Commit-Message mit Zusammenfassung
        CURRENT_DATE=$(date +%Y-%m-%d)
        CHANGED_COUNT=$(git status --porcelain | wc -l)
        
        cat > commit_message.txt << EOF
        Final commit: Monthly back element update - $CURRENT_DATE
        
        Completed automatic back element updates for remaining $CHANGED_COUNT files.
        (Note: Most files were already committed via intermediate commits during processing)
        
        ðŸ¤– Generated by monthly workflow
        âš™ï¸ Processed with python/batch_process_back-element.py
        ðŸ“Š PMB data enrichment and post-processing applied
        
        Changes detected since: $(date -d "1 month ago" +%Y-%m-%d)
        EOF
        
        # Commit mit der generierten Message
        git commit -F commit_message.txt
        
        echo "Committed final changes, attempting to push..."
        # Pull latest changes first in case of intermediate commits
        git pull --rebase
        git push
        
        echo "âœ… Successfully pushed final back element updates"
    
    - name: Create workflow summary
      if: always()
      run: |
        echo "# Monthly Back Element Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(date +%H:%M:%S) UTC" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
          echo "âœ… **Changes detected** in editions/ folder from the last month" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-git-changes.outputs.files_changed }}" == "true" ]; then
            CHANGED_COUNT=$(git status --porcelain | wc -l || echo "unknown")
            echo "âœ… **Files updated:** $CHANGED_COUNT files processed and committed" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Status:** Back elements successfully updated and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Files updated:** No actual changes after processing" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ **Status:** No commit needed - all back elements were already up to date" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â„¹ï¸ **No changes** detected in editions/ folder from the last month" >> $GITHUB_STEP_SUMMARY
          echo "â­ï¸ **Status:** Skipped processing - no updates needed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*This workflow runs automatically on the 1st of each month at 4:00 AM UTC*" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Monthly back element update failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        echo "The workflow can be manually re-run from the Actions tab." >> $GITHUB_STEP_SUMMARY
