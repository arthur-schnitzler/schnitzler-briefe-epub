name: Erzeuge CMIF, correspContext, Inhaltsverzeichnisse

on:
  workflow_dispatch:

jobs:
  generate-cmif:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: â˜• Java einrichten
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ”½ Saxon HE 10.8 herunterladen
        run: curl -L -o saxon.jar https://repo1.maven.org/maven2/net/sf/saxon/Saxon-HE/10.8/Saxon-HE-10.8.jar

      - name: ğŸ“‚ Ausgabeordner erstellen
        run: mkdir -p indices

      - name: ğŸ§¬ CMIF erzeugen mit XSLT
        run: |
          java -jar saxon.jar -s:./xslts/cmif/create-cmif.xml -xsl:xslts/cmif/01_asbwzusammenkopieren-CMIF.xsl -o:temp2.xml
          java -jar saxon.jar -s:temp2.xml -xsl:xslts/cmif/02_normalize.xsl -o:temp3.xml
          java -jar saxon.jar -s:temp3.xml -xsl:xslts/cmif/03_sort.xsl -o:temp4.xml
          java -jar saxon.jar -s:temp4.xml -xsl:xslts/cmif/04_doppelte-daten.xsl -o:temp5.xml
          java -jar saxon.jar -s:temp5.xml -xsl:xslts/cmif/05_correspContext_prev-next.xsl -o:indices/schnitzler-briefe-cmif.xml
          rm -f temp2.xml temp3.xml temp4.xml temp5.xml saxon.jar

      - name: âœ… Ã„nderungen committen & pushen (CMIF)
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          if git status --porcelain | grep indices/schnitzler-briefe-cmif.xml; then
            git add indices/schnitzler-briefe-cmif.xml
            git commit -m "Automatisch: CMIF aktualisiert"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
          else
            echo "ğŸ“­ Keine Ã„nderungen im CMIF."
          fi

  add-correspContext:
    needs: generate-cmif
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Repo erneut auschecken (mit neuem Commit)
        uses: actions/checkout@v4

      - name: ğŸ Python einrichten
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ AbhÃ¤ngigkeiten installieren
        run: pip install lxml requests

      - name: â–¶ï¸ correspContext-Skript ausfÃ¼hren
        run: python ./python/add-correspContext.py

      - name: âœ… Ã„nderungen committen & pushen (correspContext)
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          if git status --porcelain | grep .; then
            git add .
            git commit -m "Automatisch: correspContext ergÃ¤nzt"
            git pull --rebase
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
          else
            echo "ğŸ“­ Keine neuen Ã„nderungen durch Python-Skript."
          fi

  create-tocs:
    needs: add-correspContext
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Repo erneut auschecken (mit neuesten Ã„nderungen)
        uses: actions/checkout@v4

      - name: ğŸ Python einrichten
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ AbhÃ¤ngigkeiten installieren
        run: pip install lxml requests  # Falls benÃ¶tigt

      - name: â–¶ï¸ TOCs erstellen mit create-tocs.py
        run: python ./python/create-tocs.py

      - name: âœ… Ã„nderungen committen & pushen (TOCs)
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          if git status --porcelain | grep .; then
            git add .
            git commit -m "Automatisch: TOCs generiert"
            git pull --rebase
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
          else
            echo "ğŸ“­ Keine Ã„nderungen durch create-tocs.py."
          fi
